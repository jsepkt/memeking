<!DOCTYPE html>
<html lang="en"> <!-- Specify language -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO: Title Tag - CRUCIAL -->
    <title>MEMEKING: AI Meme & GIF Generator for Crypto & Meme Coins | Create Funny Memes</title>

    <!-- SEO: Meta Description - CRUCIAL -->
    <meta name="description" content="Unleash your creativity with MEMEKING, the ultimate AI meme and GIF generator for meme coin creators and crypto enthusiasts! Instantly generate hilarious, unique memes and short animated GIFs for your project, community, or just for fun. Get your $MKKG coin on Pump.fun!">

    <!-- SEO: Keywords (Less impact now, but doesn't hurt in moderation) -->
    <meta name="keywords" content="ai meme generator, ai gif generator, animated memes, meme coin, crypto memes, create memes, funny memes, MEMEKING, $MKKG, pump.fun, crypto community, meme token, AI image generator, AI animation, Solana memes">

    <!-- SEO: Canonical URL (If you have multiple URLs pointing to the same content, e.g. with/without www) -->
    <!-- <link rel="canonical" href="https://your-memeking-app-name.onrender.com/" /> --> <!-- ACTION: Uncomment and set if deployed -->

    <!-- SEO: Open Graph Tags (for social media sharing) -->
    <meta property="og:title" content="MEMEKING: AI Meme & GIF Generator for Crypto & Meme Coins">
    <meta property="og:description" content="Instantly generate hilarious memes & short animated GIFs for your meme coin or crypto project with MEMEKING's AI power!">
    <meta property="og:image" content="{{ url_for('static', filename='memeking_og_image.jpg') }}"> <!-- ACTION: Create a compelling OG image (e.g., 1200x630px) and name it memeking_og_image.jpg in your static folder -->
    <meta property="og:url" content="https://memeking-app-v1.onrender.com/"> <!-- ACTION: Replace with your live URL -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="MEMEKING">

    <!-- SEO: Twitter Card Tags (for Twitter sharing) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MEMEKING: AI Meme & GIF Generator">
    <meta name="twitter:description" content="Create viral crypto memes and animated GIFs in seconds with MEMEKING's AI! Perfect for meme coin creators and communities.">
    <meta name="twitter:image" content="{{ url_for('static', filename='memeking_twitter_card.jpg') }}"> <!-- ACTION: Create a Twitter card image (e.g., 800x418px or similar ratio) and name it memeking_twitter_card.jpg in your static folder -->
    <meta name="twitter:site" content="@pillowgoldSOL"> <!-- ACTION: Updated with your X/Twitter handle -->
    <meta name="twitter:creator" content="@pillowgoldSOL"> <!-- ACTION: Updated with your X/Twitter handle -->


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --crayon-red: #EE204D;
            --crayon-blue: #1F75FE;
            --crayon-yellow: #FFDE33;
            --crayon-green: #00A693;
            --crayon-orange: #FF8C00;
            --crayon-purple: #9932CC;
            --crayon-black: #232323;
            --paper-bg: #F8F8F0;
            --scribble-border: 2px dashed var(--crayon-black);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Comic Neue', cursive; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; color: var(--crayon-black);
            background-color: var(--paper-bg); padding: 20px 0 0 0; overflow-x: hidden;
        }

        .page-wrapper {
            width: 90%; max-width: 800px; display: flex;
            flex-direction: column; gap: 30px; padding-bottom: 80px;
        }

        .section-card {
            background-color: #fff; padding: 25px 30px; border-radius: 15px;
            border: 3px solid var(--crayon-black); box-shadow: 5px 5px 0px 0px var(--crayon-black);
            text-align: center; animation: drawIn 0.6s ease-out forwards; opacity: 0;
        }
        .section-card.hero-card { background-color: var(--crayon-yellow); border-color: var(--crayon-red); box-shadow: 5px 5px 0px 0px var(--crayon-red); }
        .section-card.generator-card { background-color: var(--crayon-blue); color: white; border-color: var(--crayon-orange); box-shadow: 5px 5px 0px 0px var(--crayon-orange); }
        .section-card.generator-card p, .section-card.generator-card h2 { color: white; }
        .section-card.generator-card textarea::placeholder { color: rgba(255,255,255,0.7); }
        .section-card.generator-card textarea { border-color: white; color: white; background-color: rgba(0,0,0,0.2); }
        .section-card.social-card { background-color: var(--crayon-green); border-color: var(--crayon-purple); box-shadow: 5px 5px 0px 0px var(--crayon-purple); }
        .section-card.social-card p, .section-card.social-card h2 { color: white; }
        .section-card.donation-card { background-color: var(--crayon-orange); border-color: var(--crayon-red); box-shadow: 5px 5px 0px 0px var(--crayon-red); color: white;}
        .section-card.donation-card p, .section-card.donation-card h2 { color: white; }
        .section-card.donation-card .wallet-address-container input { background-color: rgba(255,255,255,0.8); color: var(--crayon-black);}

        .section-card:nth-child(1) { animation-delay: 0s; }
        .section-card:nth-child(2) { animation-delay: 0.15s; }
        .section-card:nth-child(3) { animation-delay: 0.3s; }
        .section-card:nth-child(4) { animation-delay: 0.45s; }

        @keyframes drawIn {
            0% { opacity: 0; transform: translateY(20px) rotate(-2deg); }
            100% { opacity: 1; transform: translateY(0) rotate(0deg); }
        }

        .coin-logo {
            max-width: 100px; max-height: 100px; margin-bottom: 10px;
            border: 3px solid var(--crayon-black); border-radius: 50%;
            background-color: white; padding: 5px; box-shadow: 3px 3px 0px var(--crayon-purple);
        }

        h1.main-title {
            font-family: 'Gaegu', cursive; color: var(--crayon-red); font-size: 4em;
            margin-bottom: 5px; line-height: 1; text-shadow: 2px 2px 0 var(--crayon-blue);
        }

        h2.section-title {
            font-family: 'Gaegu', cursive; font-size: 2.8em;
            margin-bottom: 15px; color: inherit;
        }
        .hero-card h2.section-title { color: var(--crayon-red); text-shadow: 1px 1px 0 var(--crayon-black); }
        .generator-card h2.section-title { color: var(--crayon-yellow); text-shadow: 1px 1px 0 var(--crayon-black); }
        .social-card h2.section-title { color: var(--crayon-yellow); text-shadow: 1px 1px 0 var(--crayon-black); }
        .donation-card h2.section-title { color: var(--crayon-yellow); text-shadow: 1px 1px 0 var(--crayon-black); }

        p { font-size: 1.15em; line-height: 1.5; margin-bottom: 15px; }

        textarea#promptInput {
            width: calc(100% - 24px); padding: 15px; margin-bottom: 20px; border-radius: 10px;
            border: 3px solid var(--crayon-black); background-color: rgba(255,255,255,0.8);
            color: var(--crayon-black); min-height: 80px; font-size: 1.1em; font-family: 'Comic Neue', cursive;
        }
        .generator-card textarea#promptInput { border: 3px solid white; }
        textarea#promptInput::placeholder { color: rgba(0,0,0,0.5); }
        .generator-card textarea#promptInput::placeholder { color: rgba(255,255,255,0.7); }
        textarea#promptInput:focus { outline: none; border-color: var(--crayon-orange); }
        .generator-card textarea#promptInput:focus { border-color: var(--crayon-yellow); }

        button.crayon-button, button#generateBtn, button#generateGifBtn, button#downloadBtn, button#clearBtn, button#copyWalletBtn { /* Added #generateGifBtn */
            font-family: 'Gaegu', cursive; font-size: 1.1em; font-weight: 700; /* Slightly smaller to fit more buttons */
            color: var(--crayon-black); padding: 8px 15px; /* Slightly smaller padding */
            border: 3px solid var(--crayon-black); border-radius: 10px; cursor: pointer;
            text-transform: uppercase; transition: all 0.2s ease;
            box-shadow: 3px 3px 0px 0px var(--crayon-black);
            display: inline-flex; align-items: center; gap: 8px; margin: 5px;
        }
        button.crayon-button:hover, button#generateBtn:hover, button#generateGifBtn:hover, button#downloadBtn:hover, button#clearBtn:hover, button#copyWalletBtn:hover {
            transform: translate(2px, 2px); box-shadow: 1px 1px 0px 0px var(--crayon-black);
        }
        button.crayon-button:active, button#generateBtn:active, button#generateGifBtn:active, button#downloadBtn:active, button#clearBtn:active, button#copyWalletBtn:active {
            transform: translate(3px, 3px); box-shadow: 0px 0px 0px 0px var(--crayon-black);
        }

        /* Specific button colors */
        button#generateBtn { background-color: var(--crayon-yellow); border-color: var(--crayon-red); box-shadow: 3px 3px 0px 0px var(--crayon-red); }
        button#generateGifBtn { background-color: var(--crayon-purple); color: white; border-color: var(--crayon-yellow); box-shadow: 3px 3px 0px 0px var(--crayon-yellow); } /* Style for GIF button */
        button#buyCoinBtn { background-color: var(--crayon-green); border-color: var(--crayon-blue); box-shadow: 3px 3px 0px 0px var(--crayon-blue); }
        .social-button.x-btn { background-color: var(--crayon-blue); border-color: var(--crayon-orange); box-shadow: 3px 3px 0px 0px var(--crayon-orange); color: white; }
        .social-button.tg-btn { background-color: var(--crayon-orange); border-color: var(--crayon-purple); box-shadow: 3px 3px 0px 0px var(--crayon-purple); color: white; }
        button#downloadBtn { background-color: var(--crayon-purple); color: white; border-color: var(--crayon-yellow); box-shadow: 3px 3px 0px 0px var(--crayon-yellow); display: none; }
        button#clearBtn { background-color: var(--crayon-red); color: white; border-color: var(--crayon-blue); box-shadow: 3px 3px 0px 0px var(--crayon-blue); }
        button#copyWalletBtn { background-color: var(--crayon-yellow); border-color: var(--crayon-black); box-shadow: 3px 3px 0px 0px var(--crayon-black); color: var(--crayon-black);}

        button:disabled {
            background-color: #ccc !important; color: #777 !important; border-color: #777 !important;
            box-shadow: 1px 1px 0px 0px #777 !important; cursor: not-allowed; transform: none !important;
        }

        #memeResultContainer {
            margin-top: 20px; min-height: 200px; width: 100%;
            background-color: rgba(0,0,0,0.05); border-radius: 10px; border: var(--scribble-border);
            padding: 15px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .generator-card #memeResultContainer { background-color: rgba(255,255,255,0.1); border: 2px dashed white;}

        img#memeImage {
            max-width: 100%; max-height: 400px; border-radius: 8px;
            border: 3px solid var(--crayon-black); display: none;
            box-shadow: 3px 3px 0px var(--crayon-purple);
            animation: popInSimple 0.4s ease-out;
        }
        .generator-card img#memeImage { border: 3px solid white; box-shadow: 3px 3px 0px var(--crayon-yellow); }

        @keyframes popInSimple { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .loader {
            width: 50px; height: 50px; border: 5px solid var(--paper-bg);
            border-top-color: var(--crayon-red); border-right-color: var(--crayon-blue);
            border-bottom-color: var(--crayon-yellow); border-left-color: var(--crayon-green);
            border-radius: 50%; animation: crayonSpin 1s linear infinite; display: none;
        }
        .generator-card .loader { border: 5px solid rgba(0,0,0,0.2);
            border-top-color: var(--crayon-yellow); border-right-color: var(--crayon-red);
            border-bottom-color: var(--crayon-green); border-left-color: var(--crayon-orange);
        }

        @keyframes crayonSpin { to { transform: rotate(360deg); } }

        .message-display {
            padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold;
            display: none; border: 2px solid var(--crayon-black); width: 100%; max-width: 400px;
        }
        .error-message { color: var(--crayon-black); background-color: var(--crayon-red); }
        .generator-card .error-message { background-color: var(--crayon-red); color: white; border: 2px solid white;}

        .meme-counter-display {
            font-family: 'Gaegu', cursive; font-size: 1.3em; font-weight: 700;
            color: white; margin-top: 15px; padding: 5px 10px;
            background-color: var(--crayon-purple); border-radius: 8px;
            display: inline-block; border: 2px solid var(--crayon-black);
        }

        .wallet-address-container {
            display: flex; align-items: center; justify-content: center;
            gap: 10px; margin-top: 10px; flex-wrap: wrap;
        }
        .wallet-address-container input[type="text"] {
            font-family: 'Comic Neue', cursive; padding: 8px;
            border: 2px solid var(--crayon-black); border-radius: 8px; font-size: 0.9em;
            width: 100%; max-width: 300px; text-align: center;
        }

        .social-links-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
        .action-buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 10px; }

        .icon:before { font-family: 'Gaegu', cursive; font-weight: 700; margin-right: 5px;}
        .icon-rocket:before { content: "🚀"; }
        .icon-x:before { content: "X"; }
        .icon-telegram:before { content: "✈️"; }
        .icon-wand:before { content: "✨"; }
        .icon-gif:before { content: "🎬"; } /* New icon for GIF */
        .icon-download:before { content: "💾"; }
        .icon-clear:before { content: "🗑️"; }
        .icon-copy:before { content: "📋"; }

        footer {
            width: 100%; background-color: var(--crayon-black); color: var(--paper-bg);
            text-align: center; padding: 15px 0; font-family: 'Comic Neue', cursive;
            font-size: 0.9em; position: fixed; bottom: 0; left: 0; /* Fixed footer */
            z-index: 10; border-top: 3px solid var(--crayon-yellow);
        }

        @media (max-width: 768px) { /* Added a breakpoint for more buttons */
             button.crayon-button, button#generateBtn, button#generateGifBtn, button#downloadBtn, button#clearBtn, button#copyWalletBtn {
                 font-size: 1em; /* Slightly smaller for medium screens if many buttons */
                 padding: 8px 12px;
             }
        }

        @media (max-width: 600px) {
            h1.main-title { font-size: 3em; }
            h2.section-title { font-size: 2em; }
            .section-card { padding: 20px; }
            button.crayon-button, button#generateBtn, button#generateGifBtn, button#downloadBtn, button#clearBtn, button#copyWalletBtn {
                font-size: 0.9em; /* Even smaller for small screens */
                padding: 8px 10px;
            }
            .wallet-address-container input[type="text"] { font-size: 0.8em; max-width: 250px;}
            .page-wrapper { padding-bottom: 120px; } /* More space if footer text wraps */
            .coin-logo { max-width: 80px; max-height: 80px;}
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Hero Section -->
        <section class="section-card hero-card" aria-labelledby="hero-title">
            <img src="{{ url_for('static', filename='memeking.jpg') }}" alt="MEMEKING Coin Crayon Style Logo" class="coin-logo">
            <h1 id="hero-title" class="main-title">MEMEKING! AI Meme & GIF Generator</h1>
            <h2 class="section-title">Unleash Your Crypto Meme Creativity!</h2>
            <p>This is <strong>MEMEKING ($MKKG - *example*)</strong>, the ultimate AI-powered meme and GIF generator for meme coin creators and the crypto community! <br>No boring charts, just pure, instant meme magic for your project or for fun!</p>
            <button id="buyCoinBtn" class="crayon-button" onclick="window.open('https://pump.fun/GT3CrepnC7YSB6quSBDYH9gMr7GYcKgUc4HzEoBxpump', '_blank')">
                <span class="icon icon-rocket"></span> Get $MKKG on Pump.fun!
            </button>
            <p style="font-size: 0.9em; margin-top:10px;"><em>(V1.1 - Now with Animated GIF Memes! Create freely, but play nice.)</em></p>
        </section>

        <!-- Meme Generator Section -->
        <section class="section-card generator-card" aria-labelledby="generator-title">
            <h2 id="generator-title" class="section-title">Make a Meme or GIF!</h2>
            <p>Scribble your idea below & our AI will bring your funny crypto creation to life!</p>
            <label for="promptInput" style="display:none;">Meme/GIF Prompt</label>
            <textarea id="promptInput" placeholder="e.g., 'Solana coin character surfing on a rocket to the moon'" aria-label="Enter your meme or GIF prompt here"></textarea>

            <div class="action-buttons-container">
                <button id="generateBtn" aria-label="Generate Static Meme Image">
                    <span class="icon icon-wand"></span> Image Meme!
                </button>
                <button id="generateGifBtn" class="crayon-button" aria-label="Generate Animated GIF Meme">
                    <span class="icon icon-gif"></span> Animated GIF!
                </button>
                <button id="downloadBtn" aria-label="Download Creation"><span class="icon icon-download"></span> Download</button>
                <button id="clearBtn" aria-label="Clear Prompt and Image"><span class="icon icon-clear"></span> Clear</button>
            </div>

            <div id="memeResultContainer" role="img" aria-live="polite" aria-label="Generated meme or GIF will appear here">
                <div class="loader" id="loader" role="status" aria-label="Loading creation"></div>
                <img id="memeImage" src="#" alt="Your AI Generated Creation" style="display:none;"/>
                <div id="errorMessage" class="message-display error-message" role="alert"></div>
            </div>
            <div class="meme-counter-display">Creations Made: <span id="memeCounter">Loading...</span></div>
        </section>

        <!-- Donation Section -->
        <section class="section-card donation-card" aria-labelledby="donation-title">
             <h2 id="donation-title" class="section-title">Support the MEMEKING Kingdom!</h2>
            <p>Love MEMEKING's AI meme tool? Help us brew more creative ideas, funny features, and keep the crypto memes flowing! <br>Your support means the world (of memes)!</p>
            <div class="wallet-address-container">
                <input type="text" value="3bZ8eZLM3ZQad399YDrhGJMXXLZaFMWAfLgkA3FPaHdf" id="donationWallet" readonly aria-label="Donation Wallet Address">
                <button id="copyWalletBtn" class="crayon-button" aria-label="Copy Donation Wallet Address">
                    <span class="icon icon-copy"></span> Copy Addy
                </button>
            </div>
            <p style="font-size:0.9em; margin-top:10px;">(Network: Solana)</p>
        </section>

        <!-- Social Links Section -->
        <section class="section-card social-card" aria-labelledby="social-title">
            <h2 id="social-title" class="section-title">Join Our Crypto Meme Community!</h2>
            <p>Hang out with other Meme Kings & Queens! Follow our journey and get the latest updates for MEMEKING and $MKKG.</p>
            <div class="social-links-container">
                <button class="crayon-button social-button x-btn" onclick="window.open('https://x.com/pillowgoldSOL', '_blank')" aria-label="Follow MEMEKING on X (Twitter)">
                    <span class="icon icon-x"></span> Follow on X
                </button>
                <button class="crayon-button social-button tg-btn" onclick="window.open('https://t.me/memekingforfun', '_blank')" aria-label="Join MEMEKING Telegram group">
                    <span class="icon icon-telegram"></span> Join Telegram
                </button>
            </div>
        </section>
    </div> <!-- End of page-wrapper -->

    <footer>
        © <span id="currentYear">2024</span> Pillow Gold Developers LLC. All rights reserved. <br> <!-- Dynamic Year -->
        <a href="{{ url_for('terms_page') }}" style="color: var(--crayon-yellow); text-decoration:none;" rel="noopener">Terms & Conditions</a> |
        <a href="{{ url_for('privacy_page') }}" style="color: var(--crayon-yellow); text-decoration:none;" rel="noopener">Privacy Policy</a>
    </footer>

    <script>
        // --- DOM Elements ---
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const generateGifBtn = document.getElementById('generateGifBtn'); // New button
        const downloadBtn = document.getElementById('downloadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const memeImage = document.getElementById('memeImage');
        const loader = document.getElementById('loader');
        const errorMessageDiv = document.getElementById('errorMessage');
        const memeCounterSpan = document.getElementById('memeCounter');
        const copyWalletBtn = document.getElementById('copyWalletBtn');
        const donationWalletInput = document.getElementById('donationWallet');
        const currentYearSpan = document.getElementById('currentYear');


        const FORBIDDEN_KEYWORDS_FRONTEND = [ 
            "kill", "murder", "rape", "torture", "gore", "blood", "explicit", "nude", "naked",
            "sex", "porn", "xxx", "nazi", "racist", "hate" 
        ];

        // --- Event Listeners ---
        if (generateBtn) generateBtn.addEventListener('click', () => handleGenerateCreation('/generate-meme', 'Image Meme'));
        if (generateGifBtn) generateGifBtn.addEventListener('click', () => handleGenerateCreation('/generate-animated-meme', 'Animated GIF'));
        
        if (downloadBtn) downloadBtn.addEventListener('click', handleDownloadMeme); // Will be updated by handleGenerateCreation
        if (clearBtn) clearBtn.addEventListener('click', handleClearCreation);
        if (copyWalletBtn) copyWalletBtn.addEventListener('click', handleCopyWalletAddress);

        // --- Generic Handler for Creation ---
        async function handleGenerateCreation(endpointUrl, creationType) {
            // Null checks for critical elements used within this function
            if (!promptInput || !loader || !errorMessageDiv || !memeImage || !downloadBtn || !clearBtn || (!generateBtn && !generateGifBtn)) {
                console.error("One or more essential UI elements are missing for generation.");
                displayMessage("Oops! Something's not right with the page setup. Please refresh.", "error");
                return;
            }

            const promptText = promptInput.value.trim();
            const promptLower = promptText.toLowerCase();

            for (const keyword of FORBIDDEN_KEYWORDS_FRONTEND) {
                if (promptLower.includes(keyword)) {
                    displayMessage(`Your prompt for the ${creationType} might contain sensitive words. Please adjust your prompt.`, 'error');
                    if (generateBtn) generateBtn.disabled = false;
                    if (generateGifBtn) generateGifBtn.disabled = false;
                    if (clearBtn) clearBtn.disabled = false;
                    if (loader) loader.style.display = 'none';
                    if (generateBtn) generateBtn.innerHTML = '<span class="icon icon-wand"></span> Image Meme!';
                    if (generateGifBtn) generateGifBtn.innerHTML = '<span class="icon icon-gif"></span> Animated GIF!';
                    return;
                }
            }

            if (!promptText) {
                displayMessage(`Hey! You need to write an idea for your ${creationType} drawing!`, 'error');
                return;
            }

            memeImage.style.display = 'none'; memeImage.src = '#';
            downloadBtn.style.display = 'none';
            errorMessageDiv.style.display = 'none';
            loader.style.display = 'block';
            
            if (generateBtn) generateBtn.disabled = true;
            if (generateGifBtn) generateGifBtn.disabled = true;
            clearBtn.disabled = true;

            let clickedButton = (endpointUrl === '/generate-meme') ? generateBtn : generateGifBtn;
            let originalButtonText = clickedButton ? clickedButton.innerHTML : "";
            if (clickedButton) clickedButton.innerHTML = `<span class="icon icon-wand"></span> Conjuring ${creationType}...`;

            try {
                const response = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText })
                });

                if (response.ok) {
                    const creationBlob = await response.blob();
                    const creationUrl = URL.createObjectURL(creationBlob);
                    memeImage.src = creationUrl;
                    memeImage.style.display = 'block';
                    memeImage.alt = `Your AI Generated ${creationType}`;
                    
                    downloadBtn.style.display = 'inline-flex';
                    const extension = (creationType === 'Animated GIF') ? 'gif' : 'png'; // Default to png for static
                    const downloadFilename = `memeking_${creationType.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}.${extension}`;
                    // Update the download button's click handler directly with new URL and filename
                    downloadBtn.onclick = () => handleDownloadMeme(creationUrl, downloadFilename);

                    fetchMemeCount();
                } else {
                    let errorMsg = `Uh oh! The AI crayons are stuck for your ${creationType}.`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || `Error ${response.status}: ${response.statusText}`;
                    } catch (e) {
                        errorMsg = `Error ${response.status}: ${response.statusText}. Try again!`;
                    }
                    displayMessage(errorMsg, 'error');
                }
            } catch (error) {
                displayMessage(`Oops! Network scribbles for your ${creationType}. Check connection.`, 'error');
            } finally {
                if(loader) loader.style.display = 'none';
                if (generateBtn) { generateBtn.disabled = false; generateBtn.innerHTML = '<span class="icon icon-wand"></span> Image Meme!';}
                if (generateGifBtn) { generateGifBtn.disabled = false; generateGifBtn.innerHTML = '<span class="icon icon-gif"></span> Animated GIF!';}
                if (clearBtn) clearBtn.disabled = false;
            }
        }

        function handleDownloadMeme(urlToDownload, desiredFilename) {
            // This function is now primarily called with specific args from handleGenerateCreation's downloadBtn.onclick
            if (urlToDownload && desiredFilename) {
                const link = document.createElement('a');
                link.href = urlToDownload;
                link.download = desiredFilename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // Fallback or error if called unexpectedly without args
                console.warn("handleDownloadMeme called without proper arguments. Attempting to use current memeImage if available.");
                if (memeImage && memeImage.src && memeImage.src !== '#' && memeImage.style.display !== 'none') {
                     const link = document.createElement('a');
                     link.href = memeImage.src;
                     // Guess extension - less reliable
                     const isGif = memeImage.src.includes("blob:") ? (memeImage.alt.includes("GIF") ? true : false) : memeImage.src.endsWith('.gif');
                     link.download = `memeking_creation_${Date.now()}.${isGif ? 'gif' : 'png'}`;
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                } else {
                    displayMessage("No creation to download yet!", "error");
                }
            }
        }

        function handleClearCreation() {
            if(promptInput) promptInput.value = '';
            if(memeImage) { memeImage.style.display = 'none'; memeImage.src = '#'; }
            if(downloadBtn) downloadBtn.style.display = 'none';
            if(errorMessageDiv) errorMessageDiv.style.display = 'none';
            if(loader) loader.style.display = 'none';
            if(generateBtn) {generateBtn.disabled = false; generateBtn.innerHTML = '<span class="icon icon-wand"></span> Image Meme!';}
            if(generateGifBtn) {generateGifBtn.disabled = false; generateGifBtn.innerHTML = '<span class="icon icon-gif"></span> Animated GIF!';}
        }

        function displayMessage(message, type = 'error') {
            if (!errorMessageDiv) return;
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
            if (type === 'error') {
                if (memeImage) memeImage.style.display = 'none';
                if (downloadBtn) downloadBtn.style.display = 'none';
            }
        }

        async function fetchMemeCount() {
            if (!memeCounterSpan) return;
            try {
                const response = await fetch('/get-meme-count');
                if (response.ok) {
                    const data = await response.json();
                    memeCounterSpan.textContent = data.count;
                } else {
                    memeCounterSpan.textContent = 'N/A';
                }
            } catch (error) {
                console.error("Failed to fetch meme count:", error);
                memeCounterSpan.textContent = 'Error';
            }
        }

        function handleCopyWalletAddress() {
            if (!donationWalletInput || !copyWalletBtn) return;
            donationWalletInput.select();
            donationWalletInput.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(donationWalletInput.value).then(() => {
                    const originalText = copyWalletBtn.innerHTML;
                    copyWalletBtn.innerHTML = '<span class="icon icon-copy"></span> Copied!';
                    setTimeout(() => { copyWalletBtn.innerHTML = originalText; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy wallet address with navigator.clipboard: ', err);
                    try {
                        document.execCommand('copy'); 
                        const originalText = copyWalletBtn.innerHTML;
                        copyWalletBtn.innerHTML = '<span class="icon icon-copy"></span> Copied!';
                        setTimeout(() => { copyWalletBtn.innerHTML = originalText; }, 2000);
                    } catch (errFallback) {
                        alert('Oops, unable to copy. Please copy manually!');
                    }
                });
            } catch (err) { 
                 try {
                    document.execCommand('copy');
                    const originalText = copyWalletBtn.innerHTML;
                    copyWalletBtn.innerHTML = '<span class="icon icon-copy"></span> Copied!';
                    setTimeout(() => { copyWalletBtn.innerHTML = originalText; }, 2000);
                } catch (errFallback) {
                    alert('Oops, unable to copy. Please copy manually!');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(downloadBtn) downloadBtn.style.display = 'none';
            fetchMemeCount();
            if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear(); // Update copyright year
        });
    </script>
</body>
</html>